const Apollo = {
    version: "20240923",
    empty: "hiker://empty",
    url: "https://cn.xsz-av.com",
    d: [],
    data: {
        category: getMyVar('Apo.category', '0'),
        subCate: getMyVar('Apo.subCate', '0'),
    },
    getRangeColors: function() {
        return '#' + ('00000' + (Math.random() * 0x1000000 << 0)
                .toString(16))
            .substr(-6);
    }, //éšæœºé¢œè‰²
    baseParse: () => {
        let categoryList = [{
            "title": "æ—¥æœ¬AV",
            "path": "https://cn.xsz-av.com/videos/japanese",
            "type": "video",
            "sub": []
        }, {
            "title": "æ—¥æœ¬æ— ç ",
            "path": "https://cn.xsz-av.com/videos/uncensored",
            "type": "video",
            "sub": []
        }, {
            "title": "æ— ç æµå‡º",
            "path": "https://cn.xsz-av.com/videos/uncensored-leak",
            "type": "video",
            "sub": []
        }, {
            "title": "æ—¥æœ¬ç´ äºº",
            "path": "https://cn.xsz-av.com/videos/amateur",
            "type": "video",
            "sub": []
        }, {
            "title": "ä¸­å›½",
            "path": "https://cn.xsz-av.com/videos/chinese",
            "type": "video",
            "sub": []
        }, {
            "title": "éŸ©å›½",
            "path": "https://cn.xsz-av.com/videos/korean",
            "type": "video",
            "sub": []
        }, {
            "title": "æ¬§ç¾",
            "path": "https://cn.xsz-av.com/videos/western",
            "type": "video",
            "sub": []
        }, {
            "title": "åŠ¨æ¼«",
            "path": "https://cn.xsz-av.com/videos/hanime",
            "type": "video",
            "sub": []
        }, {
            "title": "æ ‡ç­¾",
            "path": "https://cn.xsz-av.com/tags",
            "type": "tag",
            "sub": []
        }, {
            "title": "å¥³ä¼˜",
            "path": "https://cn.xsz-av.com/actresses",
            "type": "pornstar",
            "sub": []
        }]
        const currentCate = categoryList[Apollo.data.category]
        let url
        let type = currentCate.type
        let path = currentCate.path
        if (currentCate.sub.length > 0) {
            url = Apollo.url + getMyVar("url", currentCate.sub[Apollo.data.subCate].path)
            path = currentCate.sub[Apollo.data.subCate].path
        } else {
            url = Apollo.url + getMyVar("url", currentCate.path)
        }
        url = url.replace(/https?.*(https?.*)/, "$1")
        if (MY_PAGE === 1) {
            categoryList.forEach((cate, index) => {
                Apollo.d.push({
                    title: parseInt(Apollo.data.category) === index ? 'â€œâ€œâ€â€' + cate.title.fontcolor("#FFFFFF").bold() : cate.title,
                    url: $(Apollo.empty + "#noLoading#")
                        .lazyRule((index) => {
                            putMyVar("Apo.category", index.toString())
                            putMyVar("Apo.subCate", '0')
                            clearMyVar("url")
                            clearMyVar("sort")
                            clearMyVar("yurl")
                            clearMyVar("ysort")
                            refreshPage(true)
                            return "hiker://empty"
                        }, index),
                    col_type: 'scroll_button',
                    extra: {
                        'backgroundColor': parseInt(Apollo.data.category) === index ? Apollo.getRangeColors() : ''
                    }
                })
                //ç‰¹ä¾‹ï¼Œåˆ†å‰²ç¬¬ä¸€è¡Œé¡¶éƒ¨
                if (index == 3) {
                    Apollo.d.push({
                        col_type: 'blank_block',
                    })
                } //åˆ†å‰²è¡Œ
            })
            if (currentCate.sub.length > 0) {
                Apollo.d.push({
                    col_type: 'blank_block',
                })
                currentCate.sub.forEach((cate, index) => {
                    Apollo.d.push({
                        title: parseInt(Apollo.data.subCate) === index ? 'â€œâ€œâ€â€' + cate.title.fontcolor("#FFFFFF").bold() : cate.title,
                        url: $(Apollo.empty + "#noLoading#")
                            .lazyRule((index) => {
                                putMyVar("Apo.subCate", index.toString())
                                clearMyVar("url")
                                clearMyVar("sort")
                                clearMyVar("yurl")
                                clearMyVar("ysort")
                                refreshPage(true)
                                return "hiker://empty"
                            }, index),
                        col_type: 'scroll_button',
                        extra: {
                            'backgroundColor': parseInt(Apollo.data.subCate) === index ? Apollo.getRangeColors() : ''
                        }
                    })
                })
            }
        }

        //ç¿»é¡µ
        let nextPage = getMyVar("nextPage", "");
        if (nextPage && MY_PAGE > 1) {
            if (url.includes("random")) {
                url = url
            } else {
                url = nextPage;
            };
        } else if (MY_PAGE > 1) {
            if (url.endsWith("/zh/")) {
                url = url
            } else {
                url = "æ²¡æœ‰ä¸‹ä¸€é¡µå“¦ğŸ˜‘"
            };
        }

        var html = fetch(url, {
            headers: {
                //"cookie": fetchPC('hiker://files/rules/Apollo/Cookie/youporn_cookie.txt') || '',
                "User-Agent": "Mozilla/5.0 (Linux; Android 12; PFVM10 Build/SP1A.210812.016; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/89.0.4389.72 MQQBrowser/6.2 TBS/046285 Mobile Safari/537.36",
            }
        })

        log(url)
        try {
            var next = pdfh(html, "body&&.inline-flex.isolate&&a[aria-label=Next]&&href")
            putMyVar("nextPage", next);
        } catch {
            clearMyVar("nextPage");
            //log("å¯èƒ½ä¸å­˜åœ¨ä¸‹ä¸€é¡µæˆ–è€…ä¸‹ä¸€é¡µå®šä½æœ‰é—®é¢˜");
        }

        if (MY_PAGE == 1 && url.includes("search")) {
            Apollo.d.push({
                title: 'â€œâ€œâ€â€' + "æœå¯»ç»“æœ".fontcolor("#FF00FF"),
                url: "hiker://empty",
                col_type: "text_1",
                extra: {
                    lineVisible: false
                }
            })
        }
        Apollo.videoSort(html)
        //æœç´¢
        if (MY_PAGE == 1 && !/category/.test(url)) {
            Apollo.d.push({
                title: "ğŸ”",
                url: $.toString((url) => {
                    if (input.trim() != "") {
                        putMyVar('keyword', input);
                        var searchUrl = getHome(url) + "/search/videos/" + input
                        putMyVar("url", searchUrl);
                        refreshPage();
                        return "hiker://empty"
                    } else {
                        return "confirm://æœç´¢å†…å®¹ä¸ºç©º.js:'hiker://empty'"
                    }
                }, url),
                desc: 'æœç´¢ç•ªå·...',
                col_type: "input",
                extra: {
                    defaultValue: getMyVar('keyword', '') || "",
                }
            });
        }

        switch (type) {
            case 'video':
                Apollo.videoType(url, html)
                break
            case 'pornstar':
                if (url.includes("search")) {
                    Apollo.videoType(url, html)
                } else {
                    Apollo.pornstarType(html)
                }
                break
            case 'tag':
                if (url.includes("search")) {
                    Apollo.videoType(url, html)
                } else {
                    Apollo.tagType(html)
                }
                break
            default:
                Apollo.videoType(url, html)
        }
        setResult(Apollo.d)
    },

    //ä¸€çº§sort
    videoSort: (html) => {
        if (MY_PAGE == 1) {
            Apollo.d.push({
                col_type: "blank_block",
            })
            try {
                var sort = pdfa(html, 'body&&.origin-top-right.w-56.z-10&&a')
                sort.forEach((item, index) => {
                    var title = pdfh(item, 'Text');
                    var urll = pdfh(item, 'a&&href');
                    Apollo.d.push({
                        title: (getMyVar('sort', '0') == index || getMyVar('ysort', '0') == index) ? 'â€˜â€˜â€™â€™' + title.fontcolor("#FFFFFF") : title,
                        url: urll + $('#noLoading#')
                            .lazyRule((index) => {
                                putMyVar('sort', index);
                                putMyVar("url", input);
                                putMyVar('ysort', index);
                                putMyVar("yurl", input);
                                refreshPage();
                                return 'hiker://empty'
                            }, index),
                        col_type: 'scroll_button',
                        extra: {
                            'backgroundColor': getMyVar('sort', '0') == index ? Apollo.getRangeColors() : ''
                        }
                    })
                })
            } catch {}
        }
    },

    //åŠ¨æ€åˆ†ç±»
    DynamicSort: (url, html) => {
        const åˆ†ç±»é¢œè‰² = Apollo.getRangeColors()
        const å¤§ç±»å®šä½ = 'body&&.origin-top-right.w-56.z-10'
        const æ‹¼æ¥åˆ†ç±» = ''
        const å°ç±»å®šä½ = 'body&&a'
        const åˆ†ç±»æ ‡é¢˜ = 'Text'
        const åˆ†ç±»é“¾æ¥ = 'a&&href'
        Apollo.d.push({
            col_type: "blank_block"
        });
        try {
            if (typeof(æ‹¼æ¥åˆ†ç±») != 'undefined' && æ‹¼æ¥åˆ†ç±» != '') {
                var categories = pdfa(html, å¤§ç±»å®šä½).concat(pdfa(html, æ‹¼æ¥åˆ†ç±»))
            } else {
                var categories = pdfa(html, å¤§ç±»å®šä½)
            }
        } catch {
            var categories = pdfa(html, å¤§ç±»å®šä½)
        }
        let init_cate = []
        for (let i = 0; i < 20; i++) {
            init_cate.push("0")
        }
        if (url.includes("search")) {
            var cate_temp_json = getMyVar("ysort", JSON.stringify(init_cate))
        } else {
            var cate_temp_json = getMyVar("sort", JSON.stringify(init_cate))
        }
        var cate_temp = JSON.parse(cate_temp_json)

        if (MY_PAGE == 1) {
            categories.forEach((category, index) => {
                let sub_categories = pdfa(category, å°ç±»å®šä½);
                sub_categories.forEach((item, key) => {
                    let title = pdfh(item, åˆ†ç±»æ ‡é¢˜)
                    if (typeof(æ’é™¤) != 'undefined' && æ’é™¤ != '') {
                        title = title.replace(new RegExp(æ’é™¤, "g"), "")
                    };
                    Apollo.d.push({
                        title: key.toString() === cate_temp[index] ? 'â€œâ€œâ€â€' + title.fontcolor(åˆ†ç±»é¢œè‰²) : title,
                        url: $(pdfh(item, åˆ†ç±»é“¾æ¥) + '#noLoading#').lazyRule((params) => {
                            params.cate_temp[params.index] = params.key.toString()
                            putMyVar('sort', JSON.stringify(params.cate_temp));
                            putMyVar("url", input);
                            putMyVar('ysort', JSON.stringify(params.cate_temp));
                            putMyVar("yurl", input);
                            refreshPage(true)
                            return "hiker://empty"
                        }, {
                            cate_temp: cate_temp,
                            index: index,
                            key: key,
                            page: MY_PAGE,
                        }),
                        col_type: 'scroll_button',
                        extra: {
                            'backgroundColor': key.toString() === cate_temp[index] ? Apollo.getRangeColors() : ''
                        }
                    })
                })
                Apollo.d.push({
                    col_type: "blank_block"
                });
            })
        }
    },

    //ä¸€çº§è§†é¢‘åˆ—è¡¨
    videoType: (url, html) => {
        try {
            var currpagenum = pdfh(html, "body&&.inline-flex.isolate&&.text-white&&Text").match(/\d+/)[0]
        } catch {
            var currpagenum = "1"
        }
        try {
            lastpagenum = pdfh(html, "body&&.inline-flex.isolate&&.px-4,-1&&Text").match(/\d+/)[0]
        } catch {
            var lastpagenum = currpagenum
        }
        var list = pdfa(html, "body&&.thumbnail");
        list.forEach(item => {
            var vurl = pdfh(item, 'a&&href');
            var title = pdfh(item, ".truncate&&Text");
            var img = pdfh(item, "img&&data-src"); //.replace(/(.*)w_330(.*)\/1\.jpg/, "$1w_800$2/default.jpg")
            Apollo.d.push({
                title: title,
                desc: pdfh(item, ".left-1&&Text") + "â°" + pdfh(item, ".right-1&&Text"),
                img: img ? img : "https://thumbsnap.com/i/wxDcxfJH.png",
                url: vurl + $('#noHistory#')
                    .rule(() => {
                        const Apollo = $.require('hiker://page/Apollo')
                        Apollo.videoParse(MY_URL)
                        setResult(Apollo.d)
                    }),
                col_type: "movie_2",
                extra: {
                    pageTitle: title,
                    longClick: !url.includes("/video/") ? [{
                        title: 'ã€è·³é¡µã€‘ã€å½“å‰ç¬¬>' + currpagenum + '<é¡µã€‘ã€å°¾é¡µ=>' + lastpagenum + 'é¡µã€‘',
                        js: $.toString((lastpagenum, url) => {
                                return $('', 'æ­£ç¡®çš„é¡µç ï¼š1=>' + lastpagenum + "é¡µ")
                                    .input((url, lastpagenum) => {
                                            if (input > 0 && input % 1 == 0 && input <= parseInt(lastpagenum)) {
                                                var jumpu = url.includes("page") ? url.replace(/page=\d+/, "page=" + input) : url + "?page=" + input
                                                putMyVar("url", jumpu);
                                                putMyVar("yurl", jumpu);
                                                refreshPage();
                                                return 'toast://ä½ å·²ç»ç©¿è¶Šåˆ°äº†' + input + 'é¡µ'
                                            } else {
                                                return "toast://è¯·è¾“å…¥æ­£ç¡®çš„é¡µç "
                                            }
                                        },
                                        url, lastpagenum)
                            },
                            lastpagenum, url)
                    }] : ""
                }
            })
        })
    },
    //æ ‡ç­¾
    tagType: (html) => {
        var list = pdfa(html, "body&&.grid.gap-4&&a");
        list.forEach((item, index) => {
            var vurl = pdfh(item, 'a&&href');
            Apollo.d.push({
                title: 'â€œâ€œâ€â€' + pdfh(item, "a&&Text").fontcolor("#FFFFFF"),
                url: vurl + $('##fypage')
                    .rule(() => {
                        const Apollo = $.require('hiker://page/Apollo')
                        Apollo.yijiParse(MY_URL.split("##")[0])
                        setResult(Apollo.d)
                    }),
                col_type: "flex_button",
                extra: {
                    'backgroundColor': Apollo.getRangeColors()
                }
            })
        })
        Apollo.d.push({
            col_type: "blank_block",
        })

    },

    //æ˜æ˜Ÿ
    pornstarType: (html) => {
        var list = pdfa(html, "body&&.mx-auto.grid&&.space-y-4");
        list.forEach(item => {
            var vurl = pdfh(item, 'a&&href');
            Apollo.d.push({
                title: pdfh(item, ".truncate&&Text") + pdfh(item, "p:last-child&&Text").replace("å‡ºé“", ""),
                desc: "ğŸ–¥" + pdfh(item, ".text-zinc-500&&Text"),
                img: pdfh(item, "img&&data-src") ? pdfh(item, "img&&data-src") : "https://thumbsnap.com/i/wxDcxfJH.png",
                url: vurl + $('##fypage')
                    .rule(() => {
                        const Apollo = $.require('hiker://page/Apollo')
                        Apollo.yijiParse(MY_URL.split("##")[0])
                        setResult(Apollo.d)
                    }),
                col_type: "movie_3",
            })
        })
    },

    //ä¸€çº§.ç®€
    yijiParse: (url) => {
        addListener("onClose", $.toString(() => {
            clearMyVar("yurl");
            clearMyVar("ysort");
        }));
        url = getMyVar("yurl", url)
        if (MY_PAGE !== 1) {
            url = url.includes("?") ? url + "&page=" + MY_PAGE : url + "?page=" + MY_PAGE
        }

        log(url)
        var html = fetch(url, {
            headers: {
                //"cookie": fetchPC('hiker://files/rules/Apollo/Cookie/youporn_cookie.txt') || '',
                "User-Agent": "Mozilla/5.0 (Linux; Android 12; PFVM10 Build/SP1A.210812.016; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/89.0.4389.72 MQQBrowser/6.2 TBS/046285 Mobile Safari/537.36",
            },
        });
        if (MY_PAGE == 1) {
            try {
                Apollo.d.push({
                    title: "â€œâ€œâ€â€" + pdfh(html, "body&&.justify-center.space-x-4&&p&&Text").fontcolor("#666666").bold().big(),
                    desc: "â€œâ€œâ€â€" + pdfh(html, "body&&.justify-center.space-x-4&&p,1&&Text").fontcolor("#666666").bold().big() + "\n\n" + pdfh(html, "body&&.justify-center.space-x-4&&p,2&&Text").fontcolor("#666666").bold().big(),
                    img: pdfh(html, "body&&.justify-center.space-x-4&&img&&data-src"),
                    url: "hiker://empty",
                    col_type: "movie_1_vertical_pic"
                })
            } catch {}
        }
        Apollo.videoSort(html)
        Apollo.videoType(url, html)
        setResult(Apollo.d)
    },
    //äºŒçº§
    videoParse: (url) => {
        log(url)
        var html = fetch(url, {
            headers: {
                //"cookie": fetchPC('hiker://files/rules/Apollo/Cookie/youporn_cookie.txt') || '',
                "User-Agent": "Mozilla/5.0 (Linux; Android 12; PFVM10 Build/SP1A.210812.016; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/89.0.4389.72 MQQBrowser/6.2 TBS/046285 Mobile Safari/537.36",
            },
        });
        //æ ‡é¢˜
        var title = pdfh(html, "body&&h1&&Text");
        Apollo.d.push({
            title: 'â€œâ€œâ€â€' + title.fontcolor("#E57A1A"),
            url: url,
            col_type: 'text_1',
            extra: {
                lineVisible: false,
                id: 'transdesc',
                longClick: [{
                    title: 'ç½‘é¡µ',
                    js: $.toString(() => {
                        return "web://" + MY_URL
                    })
                }, {
                    title: 'å¤åˆ¶',
                    js: $.toString((title) => {
                        return "copy://" + title;
                    }, title)
                }]
            }
        })
        //å›¾ç‰‡        
        var playervars = html.match(/https?[^"]+\.m3u8/)[0]
        //log(playervars)
        var img = pdfh(html, "body&&.video_container&&video&&data-poster");
        Apollo.d.push({
            img: img,
            url: playervars + ";{Referer@" + Apollo.url + "}", // + lazy,
            col_type: "pic_1_full",
        })
        var è¯¦ç»†ä¿¡æ¯ = pdfh(html, "body&&#description&&.mb-1&&Text").trim()
        if (è¯¦ç»†ä¿¡æ¯ != "") {
            Apollo.d.push({
                title: "â€œâ€œâ€â€" + "è¯¦ç»†ä¿¡æ¯".fontcolor("#FF00FF").bold(),
                url: "hiker://empty",
                col_type: "text_1"
            })
            Apollo.d.push({
                title: è¯¦ç»†ä¿¡æ¯.fontcolor("#666666").bold(),
                col_type: "rich_text"
            })
            Apollo.d.push({
                col_type: "line",
            })
        }
        var ç•ªå· = pdfh(html, "body&&#description&&.text-gray-700:has(span):matches(ç•ªå·:)&&Text").trim()
        if (ç•ªå· != "") {
            Apollo.d.push({
                title: "â€œâ€œâ€â€" + ç•ªå·.fontcolor("#666666").bold(),
                url: "hiker://empty",
                col_type: "text_1"
            })
        }
        var æ ‡é¢˜ = pdfh(html, "body&&#description&&.text-gray-700:has(span):matches(æ ‡é¢˜:)&&Text").trim()
        if (æ ‡é¢˜ != "") {
            Apollo.d.push({
                title: "â€œâ€œâ€â€" + æ ‡é¢˜.fontcolor("#666666").bold(),
                url: "hiker://empty",
                col_type: "text_1"
            })
        }
        //å¥³ä¼˜
        try {
            var list = pdfa(html, "body&&#description&&.text-gray-700:has(span):matches(å¥³ä¼˜:)&&a");
            list.forEach(item => {
                var vurl = pdfh(item, 'a&&href');
                var title = pdfh(item, "a&&Text");
                Apollo.d.push({
                    title: 'â€œâ€œâ€â€' + title.fontcolor("#FFFFFF"),
                    url: vurl + $('##fypage')
                        .rule(() => {
                            const Apollo = $.require('hiker://page/Apollo')
                            Apollo.yijiParse(MY_URL.split("##")[0])
                            setResult(Apollo.d)
                        }),
                    col_type: "flex_button",
                    extra: {
                        pageTitle: title,
                        'backgroundColor': Apollo.getRangeColors()
                    }
                })
            })
            Apollo.d.push({
                col_type: "line_blank",
            })
        } catch {}
        //æ ‡ç­¾
        try {
            var list = pdfa(html, "body&&#description&&.text-gray-700:has(span):matches(æ ‡ç­¾:)&&a");
            list.forEach(item => {
                var vurl = pdfh(item, 'a&&href');
                var title = pdfh(item, "a&&Text");
                Apollo.d.push({
                    title: 'â€œâ€œâ€â€' + title.fontcolor("#FFFFFF"),
                    url: vurl + $('##fypage')
                        .rule(() => {
                            const Apollo = $.require('hiker://page/Apollo')
                            Apollo.yijiParse(MY_URL.split("##")[0])
                            setResult(Apollo.d)
                        }),
                    col_type: "flex_button",
                    extra: {
                        pageTitle: title,
                        'backgroundColor': Apollo.getRangeColors()
                    }
                })
            })
        } catch {}
        //ç›¸å…³
        Apollo.d.push({
            title: "ç›¸å…³".fontcolor("#FF00FF").bold(),
            col_type: "rich_text"
        })
        Apollo.videoType(url, html)
        setResult(Apollo.d)
    },
    //æœç´¢
    searchParse: (url) => {
        keyword = url.split("##")[1]
        url = Apollo.url + "/search/videos/" + keyword + "?page=" + MY_PAGE
        log(url)
        var html = fetch(url, {
            headers: {
                //"cookie": fetchPC('hiker://files/rules/Apollo/Cookie/youporn_cookie.txt') || '',
                "User-Agent": "Mozilla/5.0 (Linux; Android 12; PFVM10 Build/SP1A.210812.016; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/89.0.4389.72 MQQBrowser/6.2 TBS/046285 Mobile Safari/537.36",
            },
        });
        // log(html)
        Apollo.videoType(url, html)
        setResult(Apollo.d)
    },

}

$.exports = Apollo