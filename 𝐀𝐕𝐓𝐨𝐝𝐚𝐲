const Apollo = {
    version: 202409133,
    empty: "hiker://empty",
    url: config.host,
    d: [],
    lazy: $('#noHistory#')
        .lazyRule(() => {
            var html = fetch(input.replace("video/", "player?s="))
            var script = html.match(/var m3u8_url.*/)[0]
            eval(script)
            return m3u8_url + ";{Origin@https://avtoday.io&&Referer@https://avtoday.io/}"
        }),
    data: {
        category: getMyVar('Apo.category', '0'),
        subCate: getMyVar('Apo.subCate', '0'),
    },
    getRangeColors: function() {
        return '#' + ('00000' + (Math.random() * 0x1000000 << 0)
                .toString(16))
            .substr(-6);
    }, //éšæœºé¢œè‰²
    baseParse: () => {
        const page = parseInt(MY_URL.split('##')[2])
        let categoryList = [{
            "title": "é¦–é¡µ",
            "path": "/",
            "type": "home",
            "sub": []
        }, {
            "title": "ðŸ“‹ç±»åž‹",
            "path": "",
            "type": "video",
            "sub": [{
                "title": "æ— ç ",
                "path": "/catalog/æ— ç "
            }, {
                "title": "åˆ¶æœ",
                "path": "/catalog/åˆ¶æœ"
            }, {
                "title": "ä¸è¢œ",
                "path": "/catalog/ä¸è¢œ"
            }, {
                "title": "èèŽ‰åž‹",
                "path": "/catalog/èèŽ‰åž‹"
            }, {
                "title": "å¤šäºº",
                "path": "/catalog/å¤šäºº"
            }, {
                "title": "é•¿è…¿",
                "path": "/catalog/é•¿è…¿"
            }, {
                "title": "å¤§å±è‚¡",
                "path": "/catalog/å¤§å±è‚¡"
            }, {
                "title": "å·¨ä¹³",
                "path": "/catalog/å·¨ä¹³"
            }, {
                "title": "è‡ªæ…°",
                "path": "/catalog/è‡ªæ…°"
            }, {
                "title": "ä¸šä½™è§†é¢‘",
                "path": "/catalog/ä¸šä½™è§†é¢‘"
            }, {
                "title": "è¶³äº¤",
                "path": "/catalog/è¶³äº¤"
            }, {
                "title": "æ½®å¹",
                "path": "/catalog/æ½®å¹"
            }, {
                "title": "ç—´å¥³",
                "path": "/catalog/ç—´å¥³"
            }, {
                "title": "ç†Ÿå¥³",
                "path": "/catalog/ç†Ÿå¥³"
            }, {
                "title": "è²§ä¹³",
                "path": "/catalog/è²§ä¹³"
            }, {
                "title": "åŠè†è¢œ",
                "path": "/catalog/åŠè†è¢œ"
            }]
        }, {
            "title": "ðŸŽ¥æ–°ç‰‡",
            "path": "/new",
            "type": "video",
            "sub": []
        }, {
            "title": "ðŸ”¥äººæ°”",
            "path": "/hot",
            "type": "video",
            "sub": []
        }, {
            "title": "ðŸˆšæ— ç ",
            "path": "/no-mosaic",
            "type": "video",
            "sub": []
        }, {
            "title": "ðŸ¤‘å…è´¹",
            "path": "/free",
            "type": "video",
            "sub": []
        }]
        const currentCate = categoryList[Apollo.data.category]
        let url
        let type = currentCate.type
        let path = currentCate.path
        if (currentCate.sub.length > 0) {
            url = Apollo.url + getMyVar("url", currentCate.sub[Apollo.data.subCate].path)
            path = currentCate.sub[Apollo.data.subCate].path
        } else {
            url = Apollo.url + getMyVar("url", currentCate.path)
        }
        url = url.replace(/https?.*(https?.*)/, "$1")
        if (page === 1) {
            categoryList.forEach((cate, index) => {
                Apollo.d.push({
                    title: parseInt(Apollo.data.category) === index ? 'â€œâ€œâ€â€' + cate.title.fontcolor(Apollo.getRangeColors()) : cate.title,
                    url: $(Apollo.empty + "#noLoading#")
                        .lazyRule((index) => {
                            putMyVar("Apo.category", index.toString())
                            putMyVar("Apo.subCate", '0')
                            clearMyVar("url")
                            refreshPage(true)
                            return "hiker://empty"
                        }, index),
                    col_type: 'scroll_button',
                })
            })
            if (currentCate.sub.length > 0) {
                Apollo.d.push({
                    col_type: 'blank_block',
                })
                currentCate.sub.forEach((cate, index) => {
                    Apollo.d.push({
                        title: parseInt(Apollo.data.subCate) === index ? 'â€œâ€œâ€â€' + cate.title.fontcolor(Apollo.getRangeColors()) : cate.title,
                        url: $(Apollo.empty + "#noLoading#")
                            .lazyRule((index) => {
                                putMyVar("Apo.subCate", index.toString())
                                clearMyVar("url")
                                refreshPage(true)
                                return "hiker://empty"
                            }, index),
                        col_type: 'scroll_button',
                    })
                })
            }
        }
        if (MY_PAGE == 1 && !/category/.test(url)) {
            Apollo.d.push({
                title: "ðŸ”",
                url: $.toString((url) => {
                    putMyVar('keyword', input);
                    var searchUrl = getHome(url) + "/search?s=" + input
                    putMyVar("url", searchUrl);
                    refreshPage();
                    return "hiker://empty"
                }, url),
                desc: 'æœç´¢...',
                col_type: "input",
                extra: {
                    defaultValue: getMyVar('keyword', '') || "",
                }
            });
        }
        //ç¿»é¡µ
        /*
        if (page !== 1) {
            url = url.includes("?") ? url + "&page=" + page : url + "?&page=" + page
        }
        const html = fetch(url, {
            headers: {
                "Cookie": fetchPC('hiker://files/rules/Apollo/Cookie/javlibrary_cookie.txt') || '',
                "User-Agent": "Mozilla/5.0 (Linux; Android 12; SM-G9750 Build/SP1A.210812.016; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/89.0.4389.72 MQQBrowser/6.2 TBS/046279 Mobile Safari/537.36",
            }
        })*/
        let nextPage = getMyVar("nextPage", "");
        if (nextPage && MY_PAGE > 1) {
            if (url.includes("random")) {
                url = url
            } else {
                url = nextPage;
            };
        } else if (MY_PAGE > 1) {
            if (url.endsWith("/zh/")) {
                url = url
            } else {
                url = "æ²¡æœ‰ä¸‹ä¸€é¡µå“¦ðŸ˜‘"
            };
        }

        var html = fetch(url, {
            headers: {
                "cookie": fetchPC('hiker://files/rules/Apollo/Cookie/avtoday_cookie.txt') || '',
                "User-Agent": "Mozilla/5.0 (Linux; Android 12; PFVM10 Build/SP1A.210812.016; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/89.0.4389.72 MQQBrowser/6.2 TBS/046285 Mobile Safari/537.36",
            }
        })

        log(url)
        try {
            var next = pd(html, ".justify-between&&li:matches(Next)&&a&&href")
            putMyVar("nextPage", next);
        } catch {
            clearMyVar("nextPage");
            //log("å¯èƒ½ä¸å­˜åœ¨ä¸‹ä¸€é¡µæˆ–è€…ä¸‹ä¸€é¡µå®šä½æœ‰é—®é¢˜");
        }

        if (url.includes("searchbyid")) {
            Apollo.d.push({
                title: 'â€œâ€œâ€â€' + "è¯†åˆ«ç æœå¯»ç»“æžœ".fontcolor("#67E0FA"),
                url: "hiker://empty",
                col_type: "text_1",
                extra: {
                    lineVisible: false
                }
            })
        }

        switch (type) {
            case 'home':
                if (MY_PAGE == 1 && !/search/.test(url)) {
                    Apollo.lunboType(html)
                }
                Apollo.videoType(url, html)
                break
            case 'video':
                Apollo.videoType(url, html)
                break
            default:
                Apollo.videoType(url, html)
        }
        setResult(Apollo.d)
    },

    //é¦–é¡µè½®æ’­
    lunboType: (html) => {
        var lundata = pdfa(html, ".featured-swiper&&.swiper-slide").map((x) => {
            var urll = pd(x, "a&&href");
            return {
                title: 'â€œâ€œâ€â€' + pdfh(x, ".slide-content&&Text").slice(0,68).split("").map(b => b.fontcolor(Apollo.getRangeColors()).small()).join(""),
                img: pd(x, "img&&src"),
                url: urll + Apollo.lazy,
            }
        });

        function banner(title, start, arr, data, cfg) {
            let id = title + 'lunbo';
            var rnum = Math.floor(Math.random() * data.length);
            var item = data[rnum];
            putMyVar('rnum', rnum);
            let time = 5000;
            let col_type = 'pic_1_card';
            let color = "white";
            let desc = '';
            if (cfg != undefined) {
                time = cfg.time ? cfg.time : time;
                col_type = cfg.col_type ? cfg.col_type : col_type;
                desc = cfg.desc ? cfg.desc : desc;
            }

            arr.push({
                col_type: "text_1",
                title: item.title,
                url: Apollo.empty,
                extra: {
                    id: id + 'title',
                    title: item.title,
                    lineVisible: false
                }
            }, {
                col_type: col_type,
                img: item.img,
                desc: desc,
                //title: item.title,
                url: item.url,
                extra: {
                    id: id + 'bar',
                    img: item.img,
                }
            }, {
                col_type: "line_blank"
            })

            if (start == false || getMyVar('benstart', 'true') == 'false') {
                unRegisterTask(id)
                return
            }

            //log(data)

            let obj = {
                data: data,
            };

            registerTask(id, time, $.toString((obj, id) => {
                var data = obj.data;
                var rum = getMyVar('rnum');

                var i = Number(getMyVar('banneri', '0'));
                if (rum != '') {
                    i = Number(rum) + 1
                    clearMyVar('rnum')
                } else {
                    i = i + 1;
                }
                //log(i)
                //log(data.length)

                if (i > data.length - 1) {
                    i = 0
                }
                var item = data[i];
                //log(item)
                try {
                    updateItem(id + 'bar', {
                        //title: item.title,
                        img: item.img,
                        url: item.url,
                        extra: {
                            title: item.title,
                            img: item.img,
                            //name: item.title.replace(/<[^>]+>/g, ''),
                            //sname: item.extra.sname,
                            //stype: item.extra.stype,
                            //surl: item.url,
                            //img:item.img,
                            //pageTitle: item.title.replace(/<[^>]+>/g, ''),
                        }
                    })
                    updateItem(id + 'title', {
                        title: item.title,
                        extra: {
                            title: item.title,
                            lineVisible: false
                        }
                    })
                } catch (e) {
                    log(e.message)
                    unRegisterTask(id)
                }
                putMyVar('banneri', i);

            }, obj, id))
        }
        banner(MY_RULE.title, true, Apollo.d, lundata, {
            time: 3333,
            col_type: 'pic_1_full',
            desc: '0'
        })
    },

    //ä¸€çº§è§†é¢‘åˆ—è¡¨
    videoType: (url, html) => {
        if (/Just\sa\smoment/.test(html)) {
            Apollo.d.push({
                title: 'â€œâ€œâ€â€' + 'èŽ·å–cookie'.fontcolor('#FF00FF').big(),
                url: url + $('').rule(() => {
                    var d = [];
                    d.push({
                        col_type: 'x5_webview_single',
                        url: MY_URL,
                        desc: 'list&&screen',
                        extra: {
                            "User-Agent": "Mozilla/5.0 (Linux; Android 12; PFVM10 Build/SP1A.210812.016; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/89.0.4389.72 MQQBrowser/6.2 TBS/046285 Mobile Safari/537.36", //PC_UA,             
                            showProgress: false,
                            js: $.toString((u) => {
                                function check() {
                                    //let nodes = document.querySelectorAll('#tags');                                    
                                    //var ua = fba.getUa()
                                    //fba.log('co::::::' + ua);                                    
                                    var htmlContent = document.documentElement.innerHTML;

                                    if (/æœç´¢ç»“æžœ/.test(htmlContent)) {
                                        var co = fba.getCookie(u);
                                        fba.log('co::::::' + co);
                                        fba.parseLazyRule($$$().lazyRule((co) => {
                                            writeFile('hiker://files/rules/Apollo/Cookie/avtoday_cookie.txt', co);
                                            toast('å·²èŽ·å–cookie');
                                            back(true);
                                        }, co));
                                    } else {
                                        setTimeout(check, 500);
                                    }
                                }
                                check();
                            }, MY_URL)
                        }
                    });
                    return setResult(d);
                }),
                col_type: 'text_center_1'
            });
        }

        try {
            var currpagenum = pdfh(html, ".justify-between&&li:has(input)&&input&&value").match(/(\d+).\/.*/)[1]
        } catch {
            var currpagenum = "1"
        }
        try {
            lastpagenum = pdfh(html, ".justify-between&&li:has(input)&&input&&value").match(/.*\/.(\d+)/)[1]
        } catch {
            var lastpagenum = currpagenum
        }
        var list = pdfa(html, "body&&.thumbnail");
        list.forEach(item => {
            var vurl = pd(item, 'a&&href');
            Apollo.d.push({
                title: pdfh(item, ".video-title&&Text"),
                desc: pdfh(item, ".video-duration&&Text"),
                img: pd(item, "img&&src") ? pd(item, "img&&src") : "https://thumbsnap.com/i/wxDcxfJH.png",
                url: vurl + Apollo.lazy,
                col_type: "movie_2",
                extra: {
                    pageTitle: pdfh(item, ".video-title&&Text"),
                    longClick: !url.includes("content") ? [{
                        title: 'ã€è·³é¡µã€‘ã€å½“å‰ç¬¬>' + currpagenum + '<é¡µã€‘ã€å°¾é¡µ=>' + lastpagenum + 'é¡µã€‘',
                        js: $.toString((lastpagenum, url) => {
                                return $('', 'æ­£ç¡®çš„é¡µç ï¼š1=>' + lastpagenum + "é¡µ")
                                    .input((url, lastpagenum) => {
                                            if (input > 0 && input % 1 == 0 && input <= parseInt(lastpagenum)) {
                                                var jumpu = url.includes("page") ? url.replace(/page=\d+/, "page=" + input) : url + "?page=" + input
                                                putMyVar("url", jumpu);
                                                refreshPage();
                                                return 'toast://ä½ å·²ç»ç©¿è¶Šåˆ°äº†' + input + 'é¡µ'
                                            } else {
                                                return "toast://è¯·è¾“å…¥æ­£ç¡®çš„é¡µç "
                                            }
                                        },
                                        url, lastpagenum)
                            },
                            lastpagenum, url)
                    }] : ""
                }
            })
        })
    },

    //æœç´¢
    searchParse: (url) => {
        url = url.replace("hiker://empty##", "")
        log(url)
        var html = fetch(url, {
            headers: {
                "cookie": fetchPC('hiker://files/rules/Apollo/Cookie/avtoday_cookie.txt') || '',
                "User-Agent": "Mozilla/5.0 (Linux; Android 12; PFVM10 Build/SP1A.210812.016; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/89.0.4389.72 MQQBrowser/6.2 TBS/046285 Mobile Safari/537.36",
            },
        });
        Apollo.videoType(url, html)
        setResult(Apollo.d)
    },

}

$.exports = Apollo